<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>KoreBot Library: kb_lrf.c Source File</title>
<link href="kteamdoxy.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.5 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="classes.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
<h1>kb_lrf.c</h1><a href="kb__lrf_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*--------------------------------------------------------------------</span>
<a name="l00002"></a>00002 <span class="comment"> * lrf.c - KoreBot Library - LedRangeFinder Support</span>
<a name="l00003"></a>00003 <span class="comment"> *--------------------------------------------------------------------</span>
<a name="l00004"></a>00004 <span class="comment"> * $Id: kb_lrf.c,v 1.5 2005/07/03 07:37:55 pbureau Exp $</span>
<a name="l00005"></a>00005 <span class="comment"> *--------------------------------------------------------------------  </span>
<a name="l00006"></a>00006 <span class="comment"> * $Author: pbureau $</span>
<a name="l00007"></a>00007 <span class="comment"> * $Date: 2005/07/03 07:37:55 $</span>
<a name="l00008"></a>00008 <span class="comment"> * $Revision: 1.5 $</span>
<a name="l00009"></a>00009 <span class="comment"> *--------------------------------------------------------------------*/</span>
<a name="l00010"></a>00010 <span class="preprocessor">#include "<a class="code" href="kb__lrf_8h.html">kb_lrf.h</a>"</span>
<a name="l00011"></a>00011 <span class="preprocessor">#include "<a class="code" href="kb__gpio_8h.html">kb_gpio.h</a>"</span>
<a name="l00012"></a>00012 <span class="preprocessor">#include "<a class="code" href="korebot_8h.html">korebot.h</a>"</span>
<a name="l00013"></a>00013 
<a name="l00029"></a><a class="code" href="kb__lrf_8c.html#013d5ee55a19626ba53fc1b696764afd">00029</a> <span class="preprocessor">#define DISTANCE_READINGS_TO_AVERAGE    3</span>
<a name="l00030"></a>00030 <span class="preprocessor"></span>
<a name="l00031"></a><a class="code" href="kb__lrf_8c.html#7d1bbb1529df8a04d27626e11496e14e">00031</a> <span class="preprocessor">#define MAX_TIMEOUT_IN_MS       500</span>
<a name="l00032"></a><a class="code" href="kb__lrf_8c.html#e57c9e215ed764e1cd1f5fe392472c39">00032</a> <span class="preprocessor"></span><span class="preprocessor">#define MAX_DATA_BYTES          246</span>
<a name="l00033"></a>00033 <span class="preprocessor"></span>
<a name="l00034"></a><a class="code" href="kb__lrf_8c.html#b7e74cad0e80e24880ab744bb96e5c94">00034</a> <span class="preprocessor">#define device "/dev/tts/2"</span>
<a name="l00035"></a>00035 <span class="preprocessor"></span><span class="comment">/* various defines */</span>
<a name="l00036"></a><a class="code" href="kb__lrf_8c.html#7d0e9775d254999299b43cc0c4fd63cf">00036</a> <span class="preprocessor">#define PXA_INT0        8</span>
<a name="l00037"></a><a class="code" href="kb__lrf_8c.html#ec78e7a9e90a406a56f859ee456e8eae">00037</a> <span class="preprocessor"></span><span class="preprocessor">#define OUT     0</span>
<a name="l00038"></a>00038 <span class="preprocessor"></span>
<a name="l00039"></a>00039 <span class="comment">/* Table for ((int) (ceil(4.0 * ((float) i) / 3.0)))  replacement */</span>
<a name="l00040"></a><a class="code" href="kb__lrf_8c.html#e66bead9e155ca397457a5d9db0dc778">00040</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <a class="code" href="kb__lrf_8c.html#e66bead9e155ca397457a5d9db0dc778">calcTable</a>[] = {
<a name="l00041"></a>00041    0x0000, 0x0002, 0x0003, 0x0004, 0x0006, 0x0007, 0x0008, 0x000A, 0x000B, 0x000C, 
<a name="l00042"></a>00042    0x000E, 0x000F, 0x0010, 0x0012, 0x0013, 0x0014, 0x0016, 0x0017, 0x0018, 0x001A, 
<a name="l00043"></a>00043    0x001B, 0x001C, 0x001E, 0x001F, 0x0020, 0x0022, 0x0023, 0x0024, 0x0026, 0x0027, 
<a name="l00044"></a>00044    0x0028, 0x002A, 0x002B, 0x002C, 0x002E, 0x002F, 0x0030, 0x0032, 0x0033, 0x0034, 
<a name="l00045"></a>00045    0x0036, 0x0037, 0x0038, 0x003A, 0x003B, 0x003C, 0x003E, 0x003F, 0x0040, 0x0042, 
<a name="l00046"></a>00046    0x0043, 0x0044, 0x0046, 0x0047, 0x0048, 0x004A, 0x004B, 0x004C, 0x004E, 0x004F, 
<a name="l00047"></a>00047    0x0050, 0x0052, 0x0053, 0x0054, 0x0056, 0x0057, 0x0058, 0x005A, 0x005B, 0x005C, 
<a name="l00048"></a>00048    0x005E, 0x005F, 0x0060, 0x0062, 0x0063, 0x0064, 0x0066, 0x0067, 0x0068, 0x006A, 
<a name="l00049"></a>00049    0x006B, 0x006C, 0x006E, 0x006F, 0x0070, 0x0072, 0x0073, 0x0074, 0x0076, 0x0077, 
<a name="l00050"></a>00050    0x0078, 0x007A, 0x007B, 0x007C, 0x007E, 0x007F, 0x0080, 0x0082, 0x0083, 0x0084, 
<a name="l00051"></a>00051    0x0086, 0x0087, 0x0088, 0x008A, 0x008B, 0x008C, 0x008E, 0x008F, 0x0090, 0x0092, 
<a name="l00052"></a>00052    0x0093, 0x0094, 0x0096, 0x0097, 0x0098, 0x009A, 0x009B, 0x009C, 0x009E, 0x009F, 
<a name="l00053"></a>00053    0x00A0, 0x00A2, 0x00A3, 0x00A4, 0x00A6, 0x00A7, 0x00A8, 0x00AA, 0x00AB, 0x00AC, 
<a name="l00054"></a>00054    0x00AE, 0x00AF, 0x00B0, 0x00B2, 0x00B3, 0x00B4, 0x00B6, 0x00B7, 0x00B8, 0x00BA, 
<a name="l00055"></a>00055    0x00BB, 0x00BC, 0x00BE, 0x00BF, 0x00C0, 0x00C2, 0x00C3, 0x00C4, 0x00C6, 0x00C7, 
<a name="l00056"></a>00056    0x00C8, 0x00CA, 0x00CB, 0x00CC, 0x00CE, 0x00CF, 0x00D0, 0x00D2, 0x00D3, 0x00D4, 
<a name="l00057"></a>00057    0x00D6, 0x00D7, 0x00D8, 0x00DA, 0x00DB, 0x00DC, 0x00DE, 0x00DF, 0x00E0, 0x00E2, 
<a name="l00058"></a>00058    0x00E3, 0x00E4, 0x00E6, 0x00E7, 0x00E8, 0x00EA, 0x00EB, 0x00EC, 0x00EE, 0x00EF, 
<a name="l00059"></a>00059    0x00F0, 0x00F2, 0x00F3, 0x00F4, 0x00F6, 0x00F7, 0x00F8, 0x00FA, 0x00FB, 0x00FC, 
<a name="l00060"></a>00060    0x00FE, 0x00FF, 0x0100, 0x0102, 0x0103, 0x0104, 0x0106, 0x0107, 0x0108, 0x010A, 
<a name="l00061"></a>00061    0x010B, 0x010C, 0x010E, 0x010F, 0x0110, 0x0112, 0x0113, 0x0114, 0x0116, 0x0117, 
<a name="l00062"></a>00062    0x0118, 0x011A, 0x011B, 0x011C, 0x011E, 0x011F, 0x0120, 0x0122, 0x0123, 0x0124, 
<a name="l00063"></a>00063    0x0126, 0x0127, 0x0128, 0x012A, 0x012B, 0x012C, 0x012E, 0x012F, 0x0130, 0x0132, 
<a name="l00064"></a>00064    0x0133, 0x0134, 0x0136, 0x0137, 0x0138, 0x013A, 0x013B, 0x013C, 0x013E, 0x013F, 
<a name="l00065"></a>00065    0x0140, 0x0142, 0x0143, 0x0144, 0x0146, 0x0147, 0x0148, 0x014A, 0x014B, 0x014C, 
<a name="l00066"></a>00066    0x014E, 0x014F, 0x0150, 0x0152, 0x0153 };
<a name="l00067"></a>00067    
<a name="l00068"></a>00068  <span class="comment">/* *****************************************************************************************</span>
<a name="l00069"></a>00069 <span class="comment">   ** LRF rs232 protocol definitions                                                      **</span>
<a name="l00070"></a>00070 <span class="comment">   *****************************************************************************************/</span>
<a name="l00071"></a><a class="code" href="kb__lrf_8c.html#acd744a917e61146ec8b7175b4761683">00071</a> <span class="preprocessor">#define STX 2</span>
<a name="l00072"></a><a class="code" href="kb__lrf_8c.html#f02558e983dd26832a852bf186ed6726">00072</a> <span class="preprocessor"></span><span class="preprocessor">#define ETX 3</span>
<a name="l00073"></a>00073 <span class="preprocessor"></span>   
<a name="l00074"></a>00074 
<a name="l00075"></a><a class="code" href="kb__lrf_8c.html#4e6b02d8873a00a34161776832fe5bd0">00075</a> <span class="preprocessor">#define LRF_PORT "/dev/tts/2"</span>
<a name="l00076"></a>00076 <span class="preprocessor"></span>
<a name="l00077"></a>00077 
<a name="l00078"></a><a class="code" href="kb__lrf_8c.html#82576f573c805f44a259706980a6701d">00078</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="kb__lrf_8c.html#82576f573c805f44a259706980a6701d">kb_lrf_Data</a>[<a class="code" href="kb__lrf_8c.html#e57c9e215ed764e1cd1f5fe392472c39">MAX_DATA_BYTES</a>];              <span class="comment">// buffer for data from LRF (ser port reply)</span>
<a name="l00079"></a>00079 
<a name="l00080"></a><a class="code" href="kb__lrf_8h.html#781533275742c1891ba6e956323a7834">00080</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <a class="code" href="kb__lrf_8c.html#781533275742c1891ba6e956323a7834">kb_lrf_DistanceData</a>[121];
<a name="l00081"></a>00081 
<a name="l00082"></a><a class="code" href="kb__lrf_8c.html#b96cd18bbb6e3bf6cd880a3dad2f0e12">00082</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <a class="code" href="kb__lrf_8c.html#b96cd18bbb6e3bf6cd880a3dad2f0e12">kb_lrf_DistanceDataSensor</a>[121];  <span class="comment">// Current Data from LRF</span>
<a name="l00083"></a><a class="code" href="kb__lrf_8c.html#7a39d6f9d149563bd6ad02ecafcd4fc5">00083</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="kb__lrf_8c.html#7a39d6f9d149563bd6ad02ecafcd4fc5">kb_lrf_DistanceDataSum</a>[121];              <span class="comment">// Summed Data from LRF</span>
<a name="l00084"></a><a class="code" href="kb__lrf_8c.html#0fd648e59f4d1c01a5659a6384603978">00084</a> <span class="keywordtype">int</span> <a class="code" href="kb__lrf_8c.html#0fd648e59f4d1c01a5659a6384603978">kb_lrf_DistanceGoodCounter</a>[121];            <span class="comment">// Counter for good readings</span>
<a name="l00085"></a>00085 
<a name="l00086"></a><a class="code" href="kb__lrf_8c.html#525c1f3eca4cfc8c120becf1c644ccf7">00086</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <a class="code" href="kb__lrf_8c.html#525c1f3eca4cfc8c120becf1c644ccf7">CertifiedCode</a>;
<a name="l00087"></a>00087 
<a name="l00088"></a>00088 <span class="preprocessor">#ifdef kt_debug_lowlevel</span>
<a name="l00089"></a>00089 <span class="preprocessor"></span>
<a name="l00090"></a>00090 <span class="comment">/* ***************************************************************************************** */</span>
<a name="l00091"></a>00091 <span class="comment">/* ** Debug function                                                                      ** */</span>
<a name="l00092"></a>00092 <span class="comment">/* ***************************************************************************************** */</span>
<a name="l00093"></a>00093 <span class="keywordtype">char</span> *Bin2Asc(<span class="keywordtype">char</span> *str, <span class="keywordtype">int</span> bin, <span class="keywordtype">int</span> sz)
<a name="l00094"></a>00094 {
<a name="l00095"></a>00095    <span class="keywordtype">int</span> i, j;
<a name="l00096"></a>00096      
<a name="l00097"></a>00097    <span class="keywordflow">for</span>( j = (sz - 1); j &gt; -1; j-- )
<a name="l00098"></a>00098    {
<a name="l00099"></a>00099       str[j] = (bin &amp; 1) + 0x30;
<a name="l00100"></a>00100       bin = bin &gt;&gt; 1;
<a name="l00101"></a>00101    }
<a name="l00102"></a>00102    
<a name="l00103"></a>00103    <span class="keywordflow">return</span> str;   
<a name="l00104"></a>00104 
<a name="l00105"></a>00105 }
<a name="l00106"></a>00106 
<a name="l00107"></a>00107 <span class="keywordtype">char</span> *Array2Raw(<span class="keywordtype">char</span> *str, <span class="keywordtype">int</span> sz)
<a name="l00108"></a>00108 {
<a name="l00109"></a>00109    <span class="keywordtype">int</span> i, j;
<a name="l00110"></a>00110    <span class="keywordtype">char</span> raw[sz+1];
<a name="l00111"></a>00111    
<a name="l00112"></a>00112       
<a name="l00113"></a>00113    <span class="keywordflow">for</span>( i = 0, j = (sz-1); i &lt; sz; i++, j-- )
<a name="l00114"></a>00114    {
<a name="l00115"></a>00115       raw[i] = (str[j] == 0x30) ? 0x31 : 0x30;
<a name="l00116"></a>00116    }
<a name="l00117"></a>00117    
<a name="l00118"></a>00118    str[0] = 0x31; <span class="comment">/* add the "stop" bit */</span>
<a name="l00119"></a>00119    
<a name="l00120"></a>00120    <span class="keywordflow">for</span>( i = 0; i &lt; sz-1; i++)
<a name="l00121"></a>00121    {
<a name="l00122"></a>00122       str[i+1] = raw[i];
<a name="l00123"></a>00123    }
<a name="l00124"></a>00124    
<a name="l00125"></a>00125    <span class="keywordflow">return</span> str;   
<a name="l00126"></a>00126 }   
<a name="l00127"></a>00127 
<a name="l00128"></a>00128 <span class="keywordtype">char</span> *makeStream(<span class="keywordtype">char</span> *outStream, <span class="keywordtype">char</span> *inMsg, <span class="keywordtype">int</span> inSz)
<a name="l00129"></a>00129 {
<a name="l00130"></a>00130    <span class="keywordtype">int</span> i, j;
<a name="l00131"></a>00131    <span class="keywordtype">char</span> *<a class="code" href="gpio__test_8c.html#c75fce8692fd1d41a8985f6aacc4a175">buf</a>;
<a name="l00132"></a>00132    
<a name="l00133"></a>00133    
<a name="l00134"></a>00134    buf = (<span class="keywordtype">char</span> *)malloc(190477);
<a name="l00135"></a>00135    memset(buf, 0, 190477);
<a name="l00136"></a>00136    
<a name="l00137"></a>00137    *outStream = 0;
<a name="l00138"></a>00138    
<a name="l00139"></a>00139    <span class="keywordflow">for</span>( i = 0; i &lt; inSz; i++ )
<a name="l00140"></a>00140    {
<a name="l00141"></a>00141       Bin2Asc(buf, inMsg[i], 8);
<a name="l00142"></a>00142       Array2Raw(buf, 8);
<a name="l00143"></a>00143       
<a name="l00144"></a>00144       strcat(outStream, buf);
<a name="l00145"></a>00145       memset(buf, 0, 190477);
<a name="l00146"></a>00146    }
<a name="l00147"></a>00147      
<a name="l00148"></a>00148    free(buf);
<a name="l00149"></a>00149    
<a name="l00150"></a>00150    <span class="keywordflow">return</span> outStream;
<a name="l00151"></a>00151 }
<a name="l00152"></a>00152 
<a name="l00153"></a>00153 <span class="preprocessor">#endif</span>
<a name="l00154"></a>00154 <span class="preprocessor"></span>
<a name="l00155"></a>00155 <span class="comment">/*****************************************************************************/</span>
<a name="l00163"></a><a class="code" href="kb__lrf_8c.html#ed94810cbce985a9f73ad48c7cc5701b">00163</a> <span class="keywordtype">int</span> <a class="code" href="kb__lrf_8c.html#ed94810cbce985a9f73ad48c7cc5701b">kb_lrf_OpenComPort</a>(<span class="keywordtype">void</span>)
<a name="l00164"></a>00164 {
<a name="l00165"></a>00165   <span class="keywordtype">int</span>     LRF_DeviceHandle;
<a name="l00166"></a>00166   <span class="keyword">struct </span>termios tty;
<a name="l00167"></a>00167 
<a name="l00168"></a>00168   <span class="keywordflow">if</span> ((LRF_DeviceHandle = open(<a class="code" href="kb__lrf_8c.html#4e6b02d8873a00a34161776832fe5bd0">LRF_PORT</a>, O_RDWR)) &lt; 0)
<a name="l00169"></a>00169   {
<a name="l00170"></a>00170   
<a name="l00171"></a>00171     <a class="code" href="kb__error_8h.html#1e8c5b4612d67bb89a75592811271498">KB_ERROR</a>(<span class="stringliteral">"kb_lrf_OpenComPort"</span>,<a class="code" href="kb__error_8h.html#d1e55d7031d529ef8d4488ad836d13eb">KB_ERROR_OPENLRF</a>, <a class="code" href="kb__lrf_8c.html#4e6b02d8873a00a34161776832fe5bd0">LRF_PORT</a>);
<a name="l00172"></a>00172     <span class="keywordflow">return</span>(-1);
<a name="l00173"></a>00173   }
<a name="l00174"></a>00174 
<a name="l00175"></a>00175   <span class="comment">/* set serial port parameters */</span>
<a name="l00176"></a>00176   tcgetattr(LRF_DeviceHandle, &amp;tty);
<a name="l00177"></a>00177   cfsetospeed(&amp;tty, (speed_t) B57600);
<a name="l00178"></a>00178   cfsetispeed(&amp;tty, (speed_t) B57600);
<a name="l00179"></a>00179   tty.c_cflag = (tty.c_cflag &amp; ~(CSIZE)) | CS7 | CSTOPB | CLOCAL | CREAD ;
<a name="l00180"></a>00180   tty.c_iflag = IGNBRK;
<a name="l00181"></a>00181   tty.c_lflag = 0; 
<a name="l00182"></a>00182   tty.c_oflag = 0;
<a name="l00183"></a>00183   tty.c_cc[VMIN] = 1;
<a name="l00184"></a>00184   tty.c_cc[VTIME] = 5;
<a name="l00185"></a>00185   tcsetattr(LRF_DeviceHandle, TCSANOW, &amp;tty);
<a name="l00186"></a>00186 
<a name="l00187"></a>00187   <span class="keywordflow">return</span>(LRF_DeviceHandle);
<a name="l00188"></a>00188 }
<a name="l00189"></a>00189 
<a name="l00190"></a>00190 
<a name="l00191"></a>00191 <span class="comment">/*****************************************************************************/</span>
<a name="l00198"></a><a class="code" href="kb__lrf_8c.html#92b480c3976b2cd1042d807b8772a14b">00198</a> <span class="keywordtype">void</span> <a class="code" href="kb__lrf_8c.html#92b480c3976b2cd1042d807b8772a14b">kb_lrf_FlushSerPort</a>(<span class="keywordtype">int</span> LRF_DeviceHandle)
<a name="l00199"></a>00199 {
<a name="l00200"></a>00200   fd_set                <a class="code" href="kb__lrftest_8c.html#f8d2d75382456ff9e4c1c90d3d0898a4">fd_set1</a>;        
<a name="l00201"></a>00201   <span class="keyword">struct </span>timeval        tv;
<a name="l00202"></a>00202   <span class="keywordtype">char</span> InputDummy;
<a name="l00203"></a>00203 
<a name="l00204"></a>00204   tv.tv_sec = 0;
<a name="l00205"></a>00205   tv.tv_usec = 0;
<a name="l00206"></a>00206   FD_ZERO(&amp;fd_set1);
<a name="l00207"></a>00207   FD_SET(LRF_DeviceHandle, &amp;fd_set1);
<a name="l00208"></a>00208   
<a name="l00209"></a>00209   <span class="keywordflow">while</span> (select(FD_SETSIZE, &amp;fd_set1, NULL, NULL, &amp;tv) &gt; 0)
<a name="l00210"></a>00210   {
<a name="l00211"></a>00211     (void) read(LRF_DeviceHandle, &amp;InputDummy, 1);
<a name="l00212"></a>00212     FD_ZERO(&amp;fd_set1);
<a name="l00213"></a>00213     FD_SET(LRF_DeviceHandle, &amp;fd_set1);
<a name="l00214"></a>00214   }
<a name="l00215"></a>00215 }
<a name="l00216"></a>00216 
<a name="l00217"></a>00217 <span class="comment">/*****************************************************************************/</span>
<a name="l00224"></a><a class="code" href="kb__lrf_8c.html#654a72d21e57e92848381769b5922392">00224</a> <span class="preprocessor">#define HKO_POLY        0x1021 </span>
<a name="l00225"></a><a class="code" href="kb__lrf_8c.html#e6ec60dea86d1d1aaca259b3cc6a0cb6">00225</a> <span class="preprocessor">unsigned char kb_lrf_lsb_to_msb(unsigned char lsb)</span>
<a name="l00226"></a>00226 <span class="preprocessor"></span>{
<a name="l00227"></a>00227   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> msb=0;
<a name="l00228"></a>00228   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> i, tmp;
<a name="l00229"></a>00229 
<a name="l00230"></a>00230   <span class="keywordflow">for</span>(i=0; i&lt;8; i++)
<a name="l00231"></a>00231   {
<a name="l00232"></a>00232     <span class="keywordflow">if</span> (i&lt;4)
<a name="l00233"></a>00233       tmp = (lsb &amp; (1&lt;&lt;i)) &lt;&lt; (((3-i)*2)+1);
<a name="l00234"></a>00234     <span class="keywordflow">else</span>
<a name="l00235"></a>00235       tmp = (lsb &amp; (1&lt;&lt;i)) &gt;&gt; (((i-4)*2)+1);
<a name="l00236"></a>00236 
<a name="l00237"></a>00237     msb |= tmp;
<a name="l00238"></a>00238   }
<a name="l00239"></a>00239   <span class="keywordflow">return</span> msb;
<a name="l00240"></a>00240 }
<a name="l00241"></a>00241 
<a name="l00242"></a>00242 <span class="comment">/*****************************************************************************/</span>
<a name="l00250"></a><a class="code" href="kb__lrf_8c.html#8c93a6aa5551e28c478855cf8ed2c749">00250</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <a class="code" href="kb__lrf_8c.html#8c93a6aa5551e28c478855cf8ed2c749">kb_lrf_GenerateCRC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *buf, <span class="keywordtype">int</span> count)
<a name="l00251"></a>00251 {
<a name="l00252"></a>00252     <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> ch, i, crc, j, v, xor_flag;
<a name="l00253"></a>00253     <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> crc_msb;
<a name="l00254"></a>00254 
<a name="l00255"></a>00255     crc = 0x0000;
<a name="l00256"></a>00256     <span class="keywordflow">for</span>(i=0; i&lt; count; i++)
<a name="l00257"></a>00257     {
<a name="l00258"></a>00258         ch = buf[i];
<a name="l00259"></a>00259   
<a name="l00260"></a>00260         v = 0x01;
<a name="l00261"></a>00261 
<a name="l00262"></a>00262         <span class="keywordflow">for</span> (j=0; j&lt;8; j++)
<a name="l00263"></a>00263         {
<a name="l00264"></a>00264             <span class="keywordflow">if</span> (crc &amp; 0x8000)
<a name="l00265"></a>00265             {
<a name="l00266"></a>00266                 xor_flag= 1;
<a name="l00267"></a>00267             }
<a name="l00268"></a>00268             <span class="keywordflow">else</span>
<a name="l00269"></a>00269             {
<a name="l00270"></a>00270                 xor_flag= 0;
<a name="l00271"></a>00271             }
<a name="l00272"></a>00272             crc = crc &lt;&lt; 1;
<a name="l00273"></a>00273 
<a name="l00274"></a>00274             <span class="keywordflow">if</span> (ch &amp; v)
<a name="l00275"></a>00275             {
<a name="l00276"></a>00276                 crc= crc + 1;
<a name="l00277"></a>00277             }
<a name="l00278"></a>00278 
<a name="l00279"></a>00279             <span class="keywordflow">if</span> (xor_flag)
<a name="l00280"></a>00280             {
<a name="l00281"></a>00281                 crc = crc ^ <a class="code" href="kb__lrf_8c.html#654a72d21e57e92848381769b5922392">HKO_POLY</a>;
<a name="l00282"></a>00282             }
<a name="l00283"></a>00283 
<a name="l00284"></a>00284             v = v &lt;&lt; 1;
<a name="l00285"></a>00285         }
<a name="l00286"></a>00286     }
<a name="l00287"></a>00287 
<a name="l00288"></a>00288     <span class="keywordflow">for</span> (i=0; i&lt;16; i++)
<a name="l00289"></a>00289     {
<a name="l00290"></a>00290         <span class="keywordflow">if</span> (crc &amp; 0x8000)
<a name="l00291"></a>00291         {
<a name="l00292"></a>00292             xor_flag= 1;
<a name="l00293"></a>00293         }
<a name="l00294"></a>00294         <span class="keywordflow">else</span>
<a name="l00295"></a>00295         {
<a name="l00296"></a>00296             xor_flag= 0;
<a name="l00297"></a>00297         }
<a name="l00298"></a>00298         crc = crc &lt;&lt; 1;
<a name="l00299"></a>00299 
<a name="l00300"></a>00300         <span class="keywordflow">if</span> (xor_flag)
<a name="l00301"></a>00301         {
<a name="l00302"></a>00302             crc = crc ^ <a class="code" href="kb__lrf_8c.html#654a72d21e57e92848381769b5922392">HKO_POLY</a>;
<a name="l00303"></a>00303         }
<a name="l00304"></a>00304     }
<a name="l00305"></a>00305  
<a name="l00306"></a>00306     crc_msb = <a class="code" href="kb__lrf_8c.html#e6ec60dea86d1d1aaca259b3cc6a0cb6">kb_lrf_lsb_to_msb</a>((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>) (crc &gt;&gt; 8));
<a name="l00307"></a>00307     crc_msb = crc_msb &lt;&lt; 8;
<a name="l00308"></a>00308     crc_msb = crc_msb | <a class="code" href="kb__lrf_8c.html#e6ec60dea86d1d1aaca259b3cc6a0cb6">kb_lrf_lsb_to_msb</a>((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>) (crc &amp; 0x00FF));
<a name="l00309"></a>00309 
<a name="l00310"></a>00310     <span class="keywordflow">return</span> crc_msb;
<a name="l00311"></a>00311 }
<a name="l00312"></a>00312 
<a name="l00313"></a>00313 <span class="comment">/*****************************************************************************/</span>
<a name="l00329"></a><a class="code" href="kb__lrf_8c.html#d050d3afcd4abe76d120f5893c0303ca">00329</a> <span class="keywordtype">int</span> <a class="code" href="kb__lrf_8c.html#d050d3afcd4abe76d120f5893c0303ca">kb_lrf_GetDataFromLRF</a>(<span class="keywordtype">int</span> LRF_DeviceHandle, <span class="keywordtype">int</span> TotalBytes)
<a name="l00330"></a>00330 {
<a name="l00331"></a>00331 
<a name="l00332"></a>00332   fd_set                fd_set0;        
<a name="l00333"></a>00333   <span class="keyword">struct </span>timeval        tv;
<a name="l00334"></a>00334 
<a name="l00335"></a>00335   <span class="keywordtype">int</span> i, j;
<a name="l00336"></a>00336   <span class="keywordtype">int</span> d0, d1, d2, d3;
<a name="l00337"></a>00337 
<a name="l00338"></a>00338   <span class="keywordtype">int</span> BytesRead;
<a name="l00339"></a>00339   <span class="keywordtype">int</span> TotalBytesRaw;
<a name="l00340"></a>00340   <span class="keywordtype">int</span> TotalBytesRead;
<a name="l00341"></a>00341   <span class="keywordtype">int</span> TotalBytesMissing;
<a name="l00342"></a>00342 
<a name="l00343"></a>00343   <span class="keywordtype">char</span> DummyInputChar;
<a name="l00344"></a>00344   <span class="keywordtype">char</span> DataRaw[2*<a class="code" href="kb__lrf_8c.html#e57c9e215ed764e1cd1f5fe392472c39">MAX_DATA_BYTES</a>];
<a name="l00345"></a>00345 
<a name="l00346"></a>00346   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> CalculatedCRC;
<a name="l00347"></a>00347   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> ReceivedCRC;
<a name="l00348"></a>00348 
<a name="l00349"></a>00349   <span class="comment">/* Calculate the raw data size from a given real data size </span>
<a name="l00350"></a>00350 <span class="comment">   * Replacement for the ugly </span>
<a name="l00351"></a>00351 <span class="comment">   *     TotalBytesRaw =((int) (ceil(4.0 * ((float) TotalBytes) / 3.0)))</span>
<a name="l00352"></a>00352 <span class="comment">   *</span>
<a name="l00353"></a>00353 <span class="comment">   *     Note : ceil() were causing issues in KoreBot environment so</span>
<a name="l00354"></a>00354 <span class="comment">   *            because data won't be bigger than 246 here is a table</span>
<a name="l00355"></a>00355 <span class="comment">   *            based replacement... </span>
<a name="l00356"></a>00356 <span class="comment">   */</span>
<a name="l00357"></a>00357 
<a name="l00358"></a>00358   TotalBytesRaw = <a class="code" href="kb__lrf_8c.html#e66bead9e155ca397457a5d9db0dc778">calcTable</a>[TotalBytes];
<a name="l00359"></a>00359 
<a name="l00360"></a>00360   <span class="comment">/* Add room for STX + ETX bytes */</span>
<a name="l00361"></a>00361   TotalBytesRaw += 2;
<a name="l00362"></a>00362   
<a name="l00363"></a>00363 
<a name="l00364"></a>00364   <span class="comment">/* Start receive loop ( loop rquired because maximum rs232 stream size per read</span>
<a name="l00365"></a>00365 <span class="comment">   * is 255 which is beyond the maximum data size we will receive... </span>
<a name="l00366"></a>00366 <span class="comment">   */</span>
<a name="l00367"></a>00367   TotalBytesRead = 0;
<a name="l00368"></a>00368   <span class="keywordflow">while</span>(TotalBytesRead &lt; TotalBytesRaw)
<a name="l00369"></a>00369   {
<a name="l00370"></a>00370     tv.tv_sec = 0;
<a name="l00371"></a>00371     tv.tv_usec = <a class="code" href="kb__lrf_8c.html#7d1bbb1529df8a04d27626e11496e14e">MAX_TIMEOUT_IN_MS</a>*1000;
<a name="l00372"></a>00372     FD_ZERO(&amp;fd_set0);
<a name="l00373"></a>00373     FD_SET(LRF_DeviceHandle, &amp;fd_set0);
<a name="l00374"></a>00374 
<a name="l00375"></a>00375     <span class="keywordflow">if</span>(select(FD_SETSIZE, &amp;fd_set0, NULL, NULL, &amp;tv) &lt;= 0)
<a name="l00376"></a>00376     {
<a name="l00377"></a>00377       <span class="comment">/* Kt_debug stuff here time out with no data */</span>
<a name="l00378"></a>00378       <span class="keywordflow">return</span>(-3);
<a name="l00379"></a>00379     }
<a name="l00380"></a>00380 
<a name="l00381"></a>00381     TotalBytesMissing = TotalBytesRaw - TotalBytesRead;
<a name="l00382"></a>00382     BytesRead = read(LRF_DeviceHandle, DataRaw+TotalBytesRead, TotalBytesMissing);
<a name="l00383"></a>00383     TotalBytesRead += BytesRead;
<a name="l00384"></a>00384   }
<a name="l00385"></a>00385 
<a name="l00386"></a>00386   <span class="comment">/* check that transmitted data have a correct lenght */</span>
<a name="l00387"></a>00387   <span class="keywordflow">if</span>(TotalBytesRead != TotalBytesRaw)
<a name="l00388"></a>00388   {
<a name="l00389"></a>00389           <span class="comment">/* Kt_debug stuff here wrong size */</span>
<a name="l00390"></a>00390       <span class="keywordflow">return</span>(-4);
<a name="l00391"></a>00391   }
<a name="l00392"></a>00392 
<a name="l00393"></a>00393   <span class="comment">/* check STX is at its correct place */</span>
<a name="l00394"></a>00394   <span class="keywordflow">if</span>(DataRaw[0] != <a class="code" href="kb__lrf_8c.html#acd744a917e61146ec8b7175b4761683">STX</a>)
<a name="l00395"></a>00395   {
<a name="l00396"></a>00396       <a class="code" href="kb__error_8h.html#1e8c5b4612d67bb89a75592811271498">KB_ERROR</a>(<span class="stringliteral">"GetDataFromLRF"</span>,<a class="code" href="kb__error_8h.html#9ea29453bf86737dc8db4b2d8d369779">KB_ERROR_LRFNOSTX</a>);
<a name="l00397"></a>00397       <span class="keywordflow">return</span>(-5);
<a name="l00398"></a>00398   }
<a name="l00399"></a>00399 
<a name="l00400"></a>00400   <span class="comment">/* check ETX is at its correct place */</span>
<a name="l00401"></a>00401   <span class="keywordflow">if</span>(DataRaw[TotalBytesRead-1] != <a class="code" href="kb__lrf_8c.html#f02558e983dd26832a852bf186ed6726">ETX</a>)
<a name="l00402"></a>00402   {
<a name="l00403"></a>00403       <a class="code" href="kb__error_8h.html#1e8c5b4612d67bb89a75592811271498">KB_ERROR</a>(<span class="stringliteral">"kb_lrf_GetDataFromLRF"</span>,<a class="code" href="kb__error_8h.html#70046fcad8076cf7dd04e9073bfd629b">KB_ERROR_LRFNOETX</a>); 
<a name="l00404"></a>00404       <span class="keywordflow">return</span>(-6);
<a name="l00405"></a>00405   }
<a name="l00406"></a>00406 
<a name="l00407"></a>00407   
<a name="l00408"></a>00408   <span class="comment">/* Initialise index variables where i is real data index</span>
<a name="l00409"></a>00409 <span class="comment">   * and j is raw data index</span>
<a name="l00410"></a>00410 <span class="comment">   * </span>
<a name="l00411"></a>00411 <span class="comment">   * j is initialised with 1 because RawData[0] is in fact STX byte</span>
<a name="l00412"></a>00412 <span class="comment">   */</span>
<a name="l00413"></a>00413   i=0;
<a name="l00414"></a>00414   j=1;
<a name="l00415"></a>00415 
<a name="l00416"></a>00416   <span class="keywordflow">while</span> (i&lt;TotalBytes+1) <span class="comment">/* +1 because first byte is STX not that there is a</span>
<a name="l00417"></a>00417 <span class="comment">                            bytes we dun even use is obviously latest byte</span>
<a name="l00418"></a>00418 <span class="comment">                            which us ETX... */</span>
<a name="l00419"></a>00419   {
<a name="l00420"></a>00420     <span class="comment">/* Works from 4 bytes of data covert back from ascii to int</span>
<a name="l00421"></a>00421 <span class="comment">           while removing 0x20... */</span>
<a name="l00422"></a>00422     d0 = DataRaw[j  ]-0x20;                     
<a name="l00423"></a>00423     d1 = DataRaw[j+1]-0x20;
<a name="l00424"></a>00424     d2 = DataRaw[j+2]-0x20;
<a name="l00425"></a>00425     d3 = DataRaw[j+3]-0x20;
<a name="l00426"></a>00426 
<a name="l00427"></a>00427     <span class="comment">/* retrieve the real values back from the uencoded64 values */</span>
<a name="l00428"></a>00428     <a class="code" href="kb__lrf_8c.html#82576f573c805f44a259706980a6701d">kb_lrf_Data</a>[i  ] = ((d0 &amp; 0x3F)&lt;&lt;2) | ((d1 &amp; 0x30)&gt;&gt;4);     
<a name="l00429"></a>00429     <a class="code" href="kb__lrf_8c.html#82576f573c805f44a259706980a6701d">kb_lrf_Data</a>[i+1] = ((d1 &amp; 0x0F)&lt;&lt;4) | ((d2 &amp; 0x3C)&gt;&gt;2);     
<a name="l00430"></a>00430     <a class="code" href="kb__lrf_8c.html#82576f573c805f44a259706980a6701d">kb_lrf_Data</a>[i+2] = ((d2 &amp; 0x03)&lt;&lt;6) | ((d3 &amp; 0x3F)   );
<a name="l00431"></a>00431 
<a name="l00432"></a>00432     <span class="comment">/* change indexes to point next group of data </span>
<a name="l00433"></a>00433 <span class="comment">       because rawdata (j) 4 bytes and realdata (i) is 3 bytes */</span>
<a name="l00434"></a>00434     i += 3;                             
<a name="l00435"></a>00435     j += 4;
<a name="l00436"></a>00436   }
<a name="l00437"></a>00437 
<a name="l00438"></a>00438   <span class="comment">/* Compute the CRC from the message we received from the sensor</span>
<a name="l00439"></a>00439 <span class="comment">     be attentive that 2 last bytes of the message is in fact CRC</span>
<a name="l00440"></a>00440 <span class="comment">     of the real message which has been appended to message */</span>
<a name="l00441"></a>00441   CalculatedCRC = <a class="code" href="kb__lrf_8c.html#8c93a6aa5551e28c478855cf8ed2c749">kb_lrf_GenerateCRC</a>(<a class="code" href="kb__lrf_8c.html#82576f573c805f44a259706980a6701d">kb_lrf_Data</a>, TotalBytes-2);
<a name="l00442"></a>00442 
<a name="l00443"></a>00443   <span class="comment">/* "extract" the crc value from the message */</span>
<a name="l00444"></a>00444   ReceivedCRC = ((<span class="keywordtype">unsigned</span> short) (<a class="code" href="kb__lrf_8c.html#82576f573c805f44a259706980a6701d">kb_lrf_Data</a>[TotalBytes-2]&lt;&lt;8) | (<a class="code" href="kb__lrf_8c.html#82576f573c805f44a259706980a6701d">kb_lrf_Data</a>[TotalBytes-1]));
<a name="l00445"></a>00445 
<a name="l00446"></a>00446   <span class="comment">/* ensure both crcs ( calculated and received ) are equal */</span>
<a name="l00447"></a>00447   <span class="keywordflow">if</span> (CalculatedCRC != ReceivedCRC)
<a name="l00448"></a>00448   {
<a name="l00449"></a>00449     <a class="code" href="kb__error_8h.html#f9e5269d30293a3811f038755fd6ebf5">KB_DEBUG</a>( <span class="stringliteral">"kb_lrf_GetDataFromLRF"</span>, 0, <span class="stringliteral">"CRC_CALCULATED = 0x%4.4X, CRC_RECEIVED = 0x%4.4X"</span>, 
<a name="l00450"></a>00450               CalculatedCRC, ReceivedCRC );
<a name="l00451"></a>00451     <span class="keywordflow">return</span>(-7);
<a name="l00452"></a>00452   }
<a name="l00453"></a>00453 
<a name="l00454"></a>00454 
<a name="l00455"></a>00455   <span class="keywordflow">return</span>(1);
<a name="l00456"></a>00456 }
<a name="l00457"></a>00457 
<a name="l00458"></a>00458 
<a name="l00459"></a>00459 
<a name="l00460"></a>00460 <span class="comment">/*****************************************************************************/</span>
<a name="l00471"></a><a class="code" href="kb__lrf_8c.html#912a4127c2f700308c70039d5f9527a2">00471</a> <span class="keywordtype">int</span> <a class="code" href="kb__lrf_8c.html#912a4127c2f700308c70039d5f9527a2">kb_lrf_SendCommand</a>(<span class="keywordtype">int</span> LRF_DeviceHandle, <span class="keywordtype">char</span> *LRF_Command, <span class="keywordtype">int</span> LRF_CommandLength)
<a name="l00472"></a>00472 {
<a name="l00473"></a>00473   fd_set                <a class="code" href="kb__lrftest_8c.html#f8d2d75382456ff9e4c1c90d3d0898a4">fd_set1</a>;                <span class="comment">/* set of file descriptors to wait for */</span>
<a name="l00474"></a>00474   <span class="keyword">struct </span>timeval        tv;             <span class="comment">/* specifies the time to wait */</span>
<a name="l00475"></a>00475 
<a name="l00476"></a>00476   <span class="keywordtype">int</span> i, j;
<a name="l00477"></a>00477   <span class="keywordtype">int</span> d0, d1, d2;
<a name="l00478"></a>00478   <span class="keywordtype">int</span> BytesToSend, RawBytesToSend, BytesWritten, ceilInt;
<a name="l00479"></a>00479 
<a name="l00480"></a>00480   <span class="keywordtype">char</span> Data[<a class="code" href="kb__lrf_8c.html#e57c9e215ed764e1cd1f5fe392472c39">MAX_DATA_BYTES</a>];
<a name="l00481"></a>00481   <span class="keywordtype">char</span> DataRaw[2*<a class="code" href="kb__lrf_8c.html#e57c9e215ed764e1cd1f5fe392472c39">MAX_DATA_BYTES</a>];
<a name="l00482"></a>00482   
<a name="l00483"></a>00483   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> CalculatedCRC;
<a name="l00484"></a>00484   <span class="keywordtype">float</span> nbrBytes, ceilVal;
<a name="l00485"></a>00485 
<a name="l00486"></a>00486   BytesToSend = LRF_CommandLength;
<a name="l00487"></a>00487 
<a name="l00488"></a>00488   <span class="keywordflow">if</span> (BytesToSend+2 &gt; <a class="code" href="kb__lrf_8c.html#e57c9e215ed764e1cd1f5fe392472c39">MAX_DATA_BYTES</a>)
<a name="l00489"></a>00489   {
<a name="l00490"></a>00490      <a class="code" href="kb__error_8h.html#1e8c5b4612d67bb89a75592811271498">KB_ERROR</a>(<span class="stringliteral">"kb_lrf_SendCommand"</span>,<a class="code" href="kb__error_8h.html#7f1707f3f67f25ac846537783c523309">KB_ERROR_LRFDATA2BIG</a>, BytesToSend+2);
<a name="l00491"></a>00491      <span class="keywordflow">return</span>(-1);
<a name="l00492"></a>00492   }
<a name="l00493"></a>00493 
<a name="l00494"></a>00494 
<a name="l00495"></a>00495   <span class="comment">/*  Empty Serial Port Input */</span>
<a name="l00496"></a>00496   <a class="code" href="kb__lrf_8c.html#92b480c3976b2cd1042d807b8772a14b">kb_lrf_FlushSerPort</a>(LRF_DeviceHandle);
<a name="l00497"></a>00497 
<a name="l00498"></a>00498   <span class="comment">/*  Calculate CRC and append to data */</span>
<a name="l00499"></a>00499   <span class="keywordflow">for</span> (i=0; i&lt;BytesToSend; i++)
<a name="l00500"></a>00500   {
<a name="l00501"></a>00501     Data[i] = LRF_Command[i];
<a name="l00502"></a>00502   }
<a name="l00503"></a>00503   CalculatedCRC = <a class="code" href="kb__lrf_8c.html#8c93a6aa5551e28c478855cf8ed2c749">kb_lrf_GenerateCRC</a>(LRF_Command, BytesToSend);
<a name="l00504"></a>00504   Data[i]   = (CalculatedCRC &amp; 0xFF00)&gt;&gt;8;
<a name="l00505"></a>00505   Data[i+1] = (CalculatedCRC &amp; 0x00FF);
<a name="l00506"></a>00506   BytesToSend += 2;
<a name="l00507"></a>00507 
<a name="l00508"></a>00508   <span class="comment">/* Convert Data to RAW sending data */</span>
<a name="l00509"></a>00509   i=0;                                                                  <span class="comment">/* pointer to real data */</span>
<a name="l00510"></a>00510   j=0;                                                                  <span class="comment">/* pointer to raw data */</span>
<a name="l00511"></a>00511 
<a name="l00512"></a>00512   <span class="keywordflow">while</span> (i&lt;BytesToSend)
<a name="l00513"></a>00513   {
<a name="l00514"></a>00514     d0 = Data[i  ];                                                     <span class="comment">/* take 3 bytes data */</span>
<a name="l00515"></a>00515     d1 = Data[i+1];
<a name="l00516"></a>00516     d2 = Data[i+2];
<a name="l00517"></a>00517 
<a name="l00518"></a>00518     DataRaw[1+j  ] = 0x20 +                       ((d0 &amp; 0xFC) &gt;&gt; 2) ;
<a name="l00519"></a>00519     DataRaw[1+j+1] = 0x20 + (((d0 &amp; 0x03) &lt;&lt; 4) | ((d1 &amp; 0xF0) &gt;&gt; 4));
<a name="l00520"></a>00520     DataRaw[1+j+2] = 0x20 + (((d1 &amp; 0x0F) &lt;&lt; 2) | ((d2 &amp; 0xC0) &gt;&gt; 6));
<a name="l00521"></a>00521     DataRaw[1+j+3] = 0x20 +  ((d2 &amp; 0x3F)     )                      ;
<a name="l00522"></a>00522 
<a name="l00523"></a>00523     i += 3;                                                             <span class="comment">/* increase pointer in raw data */</span>
<a name="l00524"></a>00524     j += 4;
<a name="l00525"></a>00525   }
<a name="l00526"></a>00526    
<a name="l00527"></a>00527   nbrBytes = (float) BytesToSend;
<a name="l00528"></a>00528   nbrBytes /= 3.0;
<a name="l00529"></a>00529   nbrBytes *= 4.0;
<a name="l00530"></a>00530   
<a name="l00531"></a>00531   <a class="code" href="kb__error_8h.html#f9e5269d30293a3811f038755fd6ebf5">KB_DEBUG</a>( <span class="stringliteral">"kb_lrf_SendCommand"</span>, 0, <span class="stringliteral">"nbrBytes=%f"</span>, nbrBytes );
<a name="l00532"></a>00532   
<a name="l00533"></a>00533   <span class="comment">/* Calculate the raw data size from a given real data size Replacement for the ugly </span>
<a name="l00534"></a>00534 <span class="comment">      RawBytesToSend =((int) (ceil(4.0 * ((float) BytesToSend) / 3.0)))</span>
<a name="l00535"></a>00535 <span class="comment"></span>
<a name="l00536"></a>00536 <span class="comment">      Note : ceil() were causing issues in KoreBot environment so</span>
<a name="l00537"></a>00537 <span class="comment">             because data won't be bigger than 246 here is a table</span>
<a name="l00538"></a>00538 <span class="comment">             based replacement... */</span>
<a name="l00539"></a>00539 
<a name="l00540"></a>00540   RawBytesToSend = <a class="code" href="kb__lrf_8c.html#e66bead9e155ca397457a5d9db0dc778">calcTable</a>[BytesToSend];
<a name="l00541"></a>00541   
<a name="l00542"></a>00542   <span class="comment">//RawBytesToSend = ((int) (ceil(4.0*(((float) BytesToSend)/3.0))));</span>
<a name="l00543"></a>00543   
<a name="l00544"></a>00544   DataRaw[0]=0x02;                      <span class="comment">// STX</span>
<a name="l00545"></a>00545   DataRaw[RawBytesToSend+1]=0x03;       <span class="comment">// ETX</span>
<a name="l00546"></a>00546   RawBytesToSend += 2;
<a name="l00547"></a>00547 
<a name="l00548"></a>00548   <span class="comment">/*  Wait for free serial port and send data off */</span>
<a name="l00549"></a>00549   tv.tv_sec = 0;
<a name="l00550"></a>00550   tv.tv_usec = 1000*<a class="code" href="kb__lrf_8c.html#7d1bbb1529df8a04d27626e11496e14e">MAX_TIMEOUT_IN_MS</a>;
<a name="l00551"></a>00551   FD_ZERO(&amp;fd_set1);
<a name="l00552"></a>00552   FD_SET(LRF_DeviceHandle, &amp;fd_set1);
<a name="l00553"></a>00553   <span class="keywordflow">if</span> (select(FD_SETSIZE, NULL, &amp;fd_set1, NULL, &amp;tv) &lt;= 0) 
<a name="l00554"></a>00554   {
<a name="l00555"></a>00555      <a class="code" href="kb__error_8h.html#1e8c5b4612d67bb89a75592811271498">KB_ERROR</a>(<span class="stringliteral">"kb_lrf_SendCommand"</span>,<a class="code" href="kb__error_8h.html#81d54b9fb1ca88281f35be15fadce858">KB_ERROR_LRFNODATA</a>); 
<a name="l00556"></a>00556      <span class="keywordflow">return</span>(-2);
<a name="l00557"></a>00557   }
<a name="l00558"></a>00558 
<a name="l00559"></a>00559   BytesWritten = write(LRF_DeviceHandle, DataRaw, RawBytesToSend);
<a name="l00560"></a>00560 
<a name="l00561"></a>00561   <span class="keywordflow">if</span> (BytesWritten != RawBytesToSend)
<a name="l00562"></a>00562   {
<a name="l00563"></a>00563      <a class="code" href="kb__error_8h.html#1e8c5b4612d67bb89a75592811271498">KB_ERROR</a>(<span class="stringliteral">"kb_lrf_SendCommand"</span>, <a class="code" href="kb__error_8h.html#035e23a8eae0e210f353d4ddc6827171">KB_ERROR_LRFSENDDATA</a>);  
<a name="l00564"></a>00564      <span class="keywordflow">return</span>(-3);
<a name="l00565"></a>00565   }
<a name="l00566"></a>00566 
<a name="l00567"></a>00567   <a class="code" href="kb__error_8h.html#f9e5269d30293a3811f038755fd6ebf5">KB_DEBUG</a>( <span class="stringliteral">"kb_lrf_SendCommand"</span>, 0, <span class="stringliteral">"bytes sent=%d"</span>, RawBytesToSend );
<a name="l00568"></a>00568   
<a name="l00569"></a>00569   <span class="keywordflow">return</span>(0);
<a name="l00570"></a>00570 }
<a name="l00571"></a>00571 
<a name="l00572"></a>00572 
<a name="l00573"></a>00573 <span class="comment">/*****************************************************************************/</span>
<a name="l00582"></a><a class="code" href="kb__lrf_8c.html#aa3aab830a01148e78616d205f3a6727">00582</a> <span class="keywordtype">int</span> <a class="code" href="kb__lrf_8c.html#aa3aab830a01148e78616d205f3a6727">kb_lrf_AcquireCertifiedCode</a>(<span class="keywordtype">int</span> LRF_DeviceHandle)
<a name="l00583"></a>00583 {
<a name="l00584"></a>00584   <span class="keywordtype">char</span> LRF_CMD[6];              <span class="comment">/* at most 5 chars + \0 */</span>
<a name="l00585"></a>00585 
<a name="l00586"></a>00586   <span class="comment">/*  Link Certified Code Acquisition */</span>
<a name="l00587"></a>00587   sprintf (LRF_CMD, <span class="stringliteral">"%c%c"</span>, 0xA0, 0x69);
<a name="l00588"></a>00588   <a class="code" href="kb__error_8h.html#f9e5269d30293a3811f038755fd6ebf5">KB_DEBUG</a>( <span class="stringliteral">"kb_lrf_AcquireCertifiedCode"</span>, 0, <span class="stringliteral">"command=%c%c"</span>, 0xA0, 0x69 );
<a name="l00589"></a>00589 
<a name="l00590"></a>00590   <a class="code" href="kb__lrf_8c.html#912a4127c2f700308c70039d5f9527a2">kb_lrf_SendCommand</a>(LRF_DeviceHandle, LRF_CMD, 2);
<a name="l00591"></a>00591 
<a name="l00592"></a>00592   <span class="keywordflow">if</span> (<a class="code" href="kb__lrf_8c.html#d050d3afcd4abe76d120f5893c0303ca">kb_lrf_GetDataFromLRF</a>(LRF_DeviceHandle, 12) &lt; 0)
<a name="l00593"></a>00593   {
<a name="l00594"></a>00594      <a class="code" href="kb__error_8h.html#1e8c5b4612d67bb89a75592811271498">KB_ERROR</a>(<span class="stringliteral">"kb_lrf_AcquireCertifiedCode"</span>, <a class="code" href="kb__error_8h.html#bc0be72c38dc1dfc35e431444b22d973">KB_ERROR_LRFNOCERT</a>);
<a name="l00595"></a>00595      <span class="keywordflow">return</span>(-1);
<a name="l00596"></a>00596   }
<a name="l00597"></a>00597   <span class="keywordflow">if</span> ((<a class="code" href="kb__lrf_8c.html#82576f573c805f44a259706980a6701d">kb_lrf_Data</a>[0] != 0xA0) || (<a class="code" href="kb__lrf_8c.html#82576f573c805f44a259706980a6701d">kb_lrf_Data</a>[1] != 0x69))
<a name="l00598"></a>00598   {
<a name="l00599"></a>00599      <a class="code" href="kb__error_8h.html#1e8c5b4612d67bb89a75592811271498">KB_ERROR</a>(<span class="stringliteral">"kb_lrf_AcquireCertifiedCode"</span>, <a class="code" href="kb__error_8h.html#81d54b9fb1ca88281f35be15fadce858">KB_ERROR_LRFNODATA</a>);
<a name="l00600"></a>00600      <span class="keywordflow">return</span>(-2);
<a name="l00601"></a>00601   }
<a name="l00602"></a>00602 
<a name="l00603"></a>00603   <a class="code" href="kb__lrf_8c.html#525c1f3eca4cfc8c120becf1c644ccf7">CertifiedCode</a> = <a class="code" href="kb__lrf_8c.html#8c93a6aa5551e28c478855cf8ed2c749">kb_lrf_GenerateCRC</a>(<a class="code" href="kb__lrf_8c.html#82576f573c805f44a259706980a6701d">kb_lrf_Data</a>+2, 8);
<a name="l00604"></a>00604 
<a name="l00605"></a>00605   <span class="keywordflow">return</span>(0);
<a name="l00606"></a>00606 }
<a name="l00607"></a>00607 
<a name="l00608"></a>00608 <span class="comment">/*****************************************************************************/</span>
<a name="l00618"></a><a class="code" href="kb__lrf_8c.html#f288b36e711aaa3fb11364895f61aae2">00618</a> <span class="keywordtype">int</span> <a class="code" href="kb__lrf_8c.html#f288b36e711aaa3fb11364895f61aae2">kb_lrf_CertifyLink</a>(<span class="keywordtype">int</span> LRF_DeviceHandle)
<a name="l00619"></a>00619 {
<a name="l00620"></a>00620   <span class="keywordtype">char</span> LRF_CMD[6];              <span class="comment">// at most 5 chars + \0</span>
<a name="l00621"></a>00621 
<a name="l00622"></a>00622   sprintf (LRF_CMD, <span class="stringliteral">"%c%c%c%c%c"</span>, 0xA0, 0x5A, 0x01,
<a name="l00623"></a>00623                         ((<a class="code" href="kb__lrf_8c.html#525c1f3eca4cfc8c120becf1c644ccf7">CertifiedCode</a> &amp; 0xFF00)&gt;&gt;8), (<a class="code" href="kb__lrf_8c.html#525c1f3eca4cfc8c120becf1c644ccf7">CertifiedCode</a> &amp; 0x00FF));
<a name="l00624"></a>00624   <a class="code" href="kb__error_8h.html#f9e5269d30293a3811f038755fd6ebf5">KB_DEBUG</a>( <span class="stringliteral">"kb_lrf_CertifyLink"</span>, 0, <span class="stringliteral">"command=%c%c%c%c%c"</span>, 0xA0, 0x5A, 0x01, 
<a name="l00625"></a>00625                         ((<a class="code" href="kb__lrf_8c.html#525c1f3eca4cfc8c120becf1c644ccf7">CertifiedCode</a> &amp; 0xFF00)&gt;&gt;8), (<a class="code" href="kb__lrf_8c.html#525c1f3eca4cfc8c120becf1c644ccf7">CertifiedCode</a> &amp; 0x00FF));
<a name="l00626"></a>00626 
<a name="l00627"></a>00627   <a class="code" href="kb__lrf_8c.html#912a4127c2f700308c70039d5f9527a2">kb_lrf_SendCommand</a>(LRF_DeviceHandle, LRF_CMD, 5);
<a name="l00628"></a>00628 
<a name="l00629"></a>00629   <span class="keywordflow">if</span> (<a class="code" href="kb__lrf_8c.html#d050d3afcd4abe76d120f5893c0303ca">kb_lrf_GetDataFromLRF</a>(LRF_DeviceHandle, 5) &lt; 0)
<a name="l00630"></a>00630   {
<a name="l00631"></a>00631      <a class="code" href="kb__error_8h.html#1e8c5b4612d67bb89a75592811271498">KB_ERROR</a>(<span class="stringliteral">"kb_lrf_CertifyLink"</span>, <a class="code" href="kb__error_8h.html#bc0be72c38dc1dfc35e431444b22d973">KB_ERROR_LRFNOCERT</a>); 
<a name="l00632"></a>00632      <span class="keywordflow">return</span>(-1);
<a name="l00633"></a>00633   }
<a name="l00634"></a>00634   <span class="keywordflow">if</span> ((<a class="code" href="kb__lrf_8c.html#82576f573c805f44a259706980a6701d">kb_lrf_Data</a>[0] != 0xA0) || (<a class="code" href="kb__lrf_8c.html#82576f573c805f44a259706980a6701d">kb_lrf_Data</a>[1] != 0x5a) || (<a class="code" href="kb__lrf_8c.html#82576f573c805f44a259706980a6701d">kb_lrf_Data</a>[2] != 0x01))
<a name="l00635"></a>00635   {
<a name="l00636"></a>00636      <a class="code" href="kb__error_8h.html#1e8c5b4612d67bb89a75592811271498">KB_ERROR</a>(<span class="stringliteral">"kb_lrf_SendCommand"</span>,<a class="code" href="kb__error_8h.html#81d54b9fb1ca88281f35be15fadce858">KB_ERROR_LRFNODATA</a>); 
<a name="l00637"></a>00637      <span class="keywordflow">return</span>(-2);
<a name="l00638"></a>00638   }
<a name="l00639"></a>00639 
<a name="l00640"></a>00640   <span class="keywordflow">return</span>(0);
<a name="l00641"></a>00641 }
<a name="l00642"></a>00642 
<a name="l00643"></a>00643 
<a name="l00644"></a>00644 <span class="comment">/*****************************************************************************/</span>
<a name="l00648"></a><a class="code" href="kb__lrf_8c.html#b0449a137233cab4d48b8eebccc97fcd">00648</a> <span class="keywordtype">void</span> <a class="code" href="kb__lrf_8c.html#b0449a137233cab4d48b8eebccc97fcd">kb_lrf_pwrOn</a>(<span class="keywordtype">void</span>)
<a name="l00649"></a>00649 {
<a name="l00650"></a>00650     <a class="code" href="kb__gpio_8c.html#9c15d4671a8c8e9b2cb25245dc878574">kb_gpio_set</a>(<a class="code" href="kb__lrf_8c.html#7d0e9775d254999299b43cc0c4fd63cf">PXA_INT0</a>);
<a name="l00651"></a>00651 }
<a name="l00652"></a>00652  
<a name="l00653"></a>00653 <span class="comment">/*****************************************************************************/</span>
<a name="l00657"></a><a class="code" href="kb__lrf_8c.html#02fdb92023671c807ee35f84a1024f95">00657</a> <span class="keywordtype">void</span> <a class="code" href="kb__lrf_8c.html#02fdb92023671c807ee35f84a1024f95">kb_lrf_pwrOff</a>(<span class="keywordtype">void</span>)
<a name="l00658"></a>00658 {
<a name="l00659"></a>00659     <a class="code" href="kb__gpio_8c.html#4d046c0445b753de64ffb38888ac4bfd">kb_gpio_clear</a>(<a class="code" href="kb__lrf_8c.html#7d0e9775d254999299b43cc0c4fd63cf">PXA_INT0</a>);
<a name="l00660"></a>00660 }  
<a name="l00661"></a>00661 
<a name="l00662"></a>00662 <span class="comment">/*****************************************************************************/</span>
<a name="l00669"></a><a class="code" href="kb__lrf_8h.html#16ddc8caf23b78afcfbbeaacfce48a62">00669</a> <span class="keywordtype">int</span> <a class="code" href="kb__lrf_8c.html#16ddc8caf23b78afcfbbeaacfce48a62">kb_lrf_Init</a>(<span class="keywordtype">char</span> *LRF_DeviceName)
<a name="l00670"></a>00670 {
<a name="l00671"></a>00671   <span class="keywordtype">int</span> LRF_DeviceHandle;
<a name="l00672"></a>00672   <span class="keywordtype">int</span> rc;
<a name="l00673"></a>00673 
<a name="l00674"></a>00674   <span class="comment">/* Open port to LRF device    */</span>
<a name="l00675"></a>00675   LRF_DeviceHandle = <a class="code" href="kb__lrf_8c.html#ed94810cbce985a9f73ad48c7cc5701b">kb_lrf_OpenComPort</a>();
<a name="l00676"></a>00676   <span class="keywordflow">if</span> (LRF_DeviceHandle &lt; 0)
<a name="l00677"></a>00677   {
<a name="l00678"></a>00678      <a class="code" href="kb__error_8h.html#1e8c5b4612d67bb89a75592811271498">KB_ERROR</a>(<span class="stringliteral">"kb_lrf_OpenComPort"</span>,<a class="code" href="kb__error_8h.html#d1e55d7031d529ef8d4488ad836d13eb">KB_ERROR_OPENLRF</a>, LRF_DeviceName);
<a name="l00679"></a>00679      <span class="keywordflow">return</span>(-1);
<a name="l00680"></a>00680   }
<a name="l00681"></a>00681   
<a name="l00682"></a>00682   <span class="comment">/* Initialise the GPIO library */</span>
<a name="l00683"></a>00683   <span class="keywordflow">if</span>((rc = <a class="code" href="kb__init_8c.html#df1ca4007100c026fae148afe3e4b6f2">kb_init</a>( 0 , NULL )) &lt; 0 )
<a name="l00684"></a>00684     <span class="keywordflow">return</span> 1;
<a name="l00685"></a>00685     
<a name="l00686"></a>00686   <span class="comment">/* Init gpio module */</span>
<a name="l00687"></a>00687   <a class="code" href="kb__gpio_8c.html#985bbe2660af7e41e96720eb8f9393b3">kb_gpio_init</a>();
<a name="l00688"></a>00688     
<a name="l00689"></a>00689   <span class="comment">/* Set GPIO8 pin as gpio, ndlr: because this pin doesnt have</span>
<a name="l00690"></a>00690 <span class="comment">     an alternate function, it is not required... */</span>
<a name="l00691"></a>00691   <a class="code" href="kb__gpio_8c.html#a35b4abbeed41042307344df3d9fb498">kb_gpio_function</a>(<a class="code" href="kb__lrf_8c.html#7d0e9775d254999299b43cc0c4fd63cf">PXA_INT0</a>,0);  
<a name="l00692"></a>00692   
<a name="l00693"></a>00693   <span class="comment">/* Set GPIO8 (PXA_INT0) as output */</span>
<a name="l00694"></a>00694   <a class="code" href="kb__gpio_8c.html#1c7389775ead3304554f87ec991ba12e">kb_gpio_dir</a>(<a class="code" href="kb__lrf_8c.html#7d0e9775d254999299b43cc0c4fd63cf">PXA_INT0</a>, <a class="code" href="kb__khepera3_8h.html#ec78e7a9e90a406a56f859ee456e8eae">OUT</a>);
<a name="l00695"></a>00695 
<a name="l00696"></a>00696   <span class="comment">/* turn "on" the led range finder module */</span>
<a name="l00697"></a>00697   <a class="code" href="kb__lrf_8c.html#b0449a137233cab4d48b8eebccc97fcd">kb_lrf_pwrOn</a>();
<a name="l00698"></a>00698   
<a name="l00699"></a>00699   <span class="comment">/* Wait that 1.5 seconds before to query the lrf - 1s specified by datasheet */</span> 
<a name="l00700"></a>00700   usleep(1500*1000);
<a name="l00701"></a>00701 
<a name="l00702"></a>00702   <span class="comment">/*  Initialize LRF */</span>
<a name="l00703"></a>00703   <a class="code" href="kb__lrf_8c.html#aa3aab830a01148e78616d205f3a6727">kb_lrf_AcquireCertifiedCode</a>(LRF_DeviceHandle);
<a name="l00704"></a>00704   <a class="code" href="kb__lrf_8c.html#f288b36e711aaa3fb11364895f61aae2">kb_lrf_CertifyLink</a>(LRF_DeviceHandle);
<a name="l00705"></a>00705   
<a name="l00706"></a>00706   <span class="comment">/* Some more timer that is required */</span>
<a name="l00707"></a>00707   sleep(0.5);
<a name="l00708"></a>00708 
<a name="l00709"></a>00709   <span class="keywordflow">return</span>(LRF_DeviceHandle);
<a name="l00710"></a>00710 }
<a name="l00711"></a>00711 
<a name="l00712"></a>00712 
<a name="l00713"></a>00713 <span class="comment">/*****************************************************************************/</span>
<a name="l00720"></a><a class="code" href="kb__lrf_8h.html#700ca92fee4a6133fe5122c922ea37f3">00720</a> <span class="keywordtype">void</span> <a class="code" href="kb__lrf_8c.html#700ca92fee4a6133fe5122c922ea37f3">kb_lrf_Close</a>(<span class="keywordtype">int</span> LRF_DeviceHandle)
<a name="l00721"></a>00721 {
<a name="l00722"></a>00722 
<a name="l00723"></a>00723   <a class="code" href="kb__lrf_8c.html#02fdb92023671c807ee35f84a1024f95">kb_lrf_pwrOff</a>();
<a name="l00724"></a>00724   close(LRF_DeviceHandle);
<a name="l00725"></a>00725 }
<a name="l00726"></a>00726 
<a name="l00727"></a>00727 
<a name="l00728"></a>00728 <span class="comment">/*****************************************************************************/</span>
<a name="l00738"></a><a class="code" href="kb__lrf_8c.html#81f96897f66e15067fad9397fe877c58">00738</a> <span class="keywordtype">int</span> <a class="code" href="kb__lrf_8c.html#81f96897f66e15067fad9397fe877c58">kb_lrf_FetchDistanceFromLRF</a>(<span class="keywordtype">int</span> LRF_DeviceHandle)
<a name="l00739"></a>00739 {
<a name="l00740"></a>00740   <span class="keywordtype">char</span> LRF_CMD[2];
<a name="l00741"></a>00741   <span class="keywordtype">int</span> i;
<a name="l00742"></a>00742 
<a name="l00743"></a>00743   <span class="comment">/*  Request Distance reading */</span>
<a name="l00744"></a>00744   LRF_CMD[0]=0xA2;
<a name="l00745"></a>00745   LRF_CMD[1]=0x69;
<a name="l00746"></a>00746   <span class="keywordflow">if</span> (<a class="code" href="kb__lrf_8c.html#912a4127c2f700308c70039d5f9527a2">kb_lrf_SendCommand</a>(LRF_DeviceHandle, LRF_CMD, 2) &lt; 0)
<a name="l00747"></a>00747   {
<a name="l00748"></a>00748      <a class="code" href="kb__error_8h.html#1e8c5b4612d67bb89a75592811271498">KB_ERROR</a>(<span class="stringliteral">"kb_lrf_FetchDistanceFromLRF"</span>,<a class="code" href="kb__error_8h.html#0d63732e6039d61e222799e4cc53851f">KB_ERROR_LRFCMDTX</a>); 
<a name="l00749"></a>00749      <span class="keywordflow">return</span>(-1);
<a name="l00750"></a>00750   }
<a name="l00751"></a>00751 
<a name="l00752"></a>00752   <span class="comment">/*  Retrieve Distance data */</span>
<a name="l00753"></a>00753   <span class="keywordflow">if</span> (<a class="code" href="kb__lrf_8c.html#d050d3afcd4abe76d120f5893c0303ca">kb_lrf_GetDataFromLRF</a>(LRF_DeviceHandle, 246) &lt; 0)  <span class="comment">/* 253?? */</span>
<a name="l00754"></a>00754   {
<a name="l00755"></a>00755      <a class="code" href="kb__error_8h.html#1e8c5b4612d67bb89a75592811271498">KB_ERROR</a>(<span class="stringliteral">"kb_lrf_FetchDistanceFromLRF"</span>,<a class="code" href="kb__error_8h.html#465b277f8c8638f93ee7ca69d7328479">KB_ERROR_LRFDISTRX</a>); 
<a name="l00756"></a>00756      <span class="keywordflow">return</span>(-2);
<a name="l00757"></a>00757   }
<a name="l00758"></a>00758 
<a name="l00759"></a>00759   <span class="comment">/* Simple Check for data integrity */</span>
<a name="l00760"></a>00760   <span class="keywordflow">if</span> ((<a class="code" href="kb__lrf_8c.html#82576f573c805f44a259706980a6701d">kb_lrf_Data</a>[0] != 0xA2) || (<a class="code" href="kb__lrf_8c.html#82576f573c805f44a259706980a6701d">kb_lrf_Data</a>[1] != 0x69))
<a name="l00761"></a>00761   {
<a name="l00762"></a>00762      <a class="code" href="kb__error_8h.html#1e8c5b4612d67bb89a75592811271498">KB_ERROR</a>(<span class="stringliteral">"kb_lrf_FetchDistanceFromLRF"</span>,<a class="code" href="kb__error_8h.html#22db80f531221d6839b09ba1f805ae98">KB_ERROR_LRFDATARX</a>); 
<a name="l00763"></a>00763      <span class="keywordflow">return</span>(-3);
<a name="l00764"></a>00764   }
<a name="l00765"></a>00765 
<a name="l00766"></a>00766   <span class="comment">/* Transform bytes into distance data */</span>
<a name="l00767"></a>00767   <span class="keywordflow">for</span> (i=0; i&lt;121; i++)
<a name="l00768"></a>00768   {
<a name="l00769"></a>00769     <a class="code" href="kb__lrf_8c.html#b96cd18bbb6e3bf6cd880a3dad2f0e12">kb_lrf_DistanceDataSensor</a>[i] = (<a class="code" href="kb__lrf_8c.html#82576f573c805f44a259706980a6701d">kb_lrf_Data</a>[(2*i)+3] &lt;&lt; 8) +
<a name="l00770"></a>00770                                  <a class="code" href="kb__lrf_8c.html#82576f573c805f44a259706980a6701d">kb_lrf_Data</a>[(2*i)+2];
<a name="l00771"></a>00771   }
<a name="l00772"></a>00772 
<a name="l00773"></a>00773   <span class="keywordflow">return</span>(0);
<a name="l00774"></a>00774 }
<a name="l00775"></a>00775 
<a name="l00776"></a>00776 
<a name="l00777"></a>00777 <span class="comment">/*****************************************************************************/</span>
<a name="l00787"></a><a class="code" href="kb__lrf_8h.html#90eac9b211d77a906e9e01e54df4c566">00787</a> <span class="keywordtype">int</span> <a class="code" href="kb__lrf_8c.html#90eac9b211d77a906e9e01e54df4c566">kb_lrf_GetDistances</a>(<span class="keywordtype">int</span> LRF_DeviceHandle)
<a name="l00788"></a>00788 {
<a name="l00789"></a>00789   <span class="keywordtype">int</span> i, j;
<a name="l00790"></a>00790 
<a name="l00791"></a>00791   <span class="comment">/* Certify Link */</span>
<a name="l00792"></a>00792   <span class="keywordflow">if</span> (<a class="code" href="kb__lrf_8c.html#f288b36e711aaa3fb11364895f61aae2">kb_lrf_CertifyLink</a>(LRF_DeviceHandle) &lt; 0)
<a name="l00793"></a>00793   {
<a name="l00794"></a>00794     <a class="code" href="kb__lrf_8c.html#aa3aab830a01148e78616d205f3a6727">kb_lrf_AcquireCertifiedCode</a>(LRF_DeviceHandle);              <span class="comment">// get new certificate</span>
<a name="l00795"></a>00795 
<a name="l00796"></a>00796     <span class="keywordflow">if</span> (<a class="code" href="kb__lrf_8c.html#f288b36e711aaa3fb11364895f61aae2">kb_lrf_CertifyLink</a>(LRF_DeviceHandle) &lt; 0)                       <span class="comment">// still problems?</span>
<a name="l00797"></a>00797     {
<a name="l00798"></a>00798        <a class="code" href="kb__error_8h.html#1e8c5b4612d67bb89a75592811271498">KB_ERROR</a>(<span class="stringliteral">"kb_lrf_GetDistances"</span>, <a class="code" href="kb__error_8h.html#bc0be72c38dc1dfc35e431444b22d973">KB_ERROR_LRFNOCERT</a>);
<a name="l00799"></a>00799        <span class="keywordflow">return</span> (-1);
<a name="l00800"></a>00800     }
<a name="l00801"></a>00801   }
<a name="l00802"></a>00802 
<a name="l00803"></a>00803   <span class="comment">/* Clear averaging memory */</span>
<a name="l00804"></a>00804   <span class="keywordflow">for</span> (j=0; j&lt;121; j++)
<a name="l00805"></a>00805   {
<a name="l00806"></a>00806     <a class="code" href="kb__lrf_8c.html#7a39d6f9d149563bd6ad02ecafcd4fc5">kb_lrf_DistanceDataSum</a>[j]     = 0;
<a name="l00807"></a>00807     <a class="code" href="kb__lrf_8c.html#0fd648e59f4d1c01a5659a6384603978">kb_lrf_DistanceGoodCounter</a>[j] = 0;
<a name="l00808"></a>00808   }
<a name="l00809"></a>00809 
<a name="l00810"></a>00810   <span class="comment">/* Get several readings to average */</span>
<a name="l00811"></a>00811   <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="kb__lrf_8c.html#013d5ee55a19626ba53fc1b696764afd">DISTANCE_READINGS_TO_AVERAGE</a>; i++)
<a name="l00812"></a>00812   {
<a name="l00813"></a>00813     (void) <a class="code" href="kb__lrf_8c.html#81f96897f66e15067fad9397fe877c58">kb_lrf_FetchDistanceFromLRF</a>(LRF_DeviceHandle);
<a name="l00814"></a>00814     <span class="keywordflow">for</span> (j=0; j&lt;121; j++)
<a name="l00815"></a>00815     {
<a name="l00816"></a>00816       <span class="keywordflow">if</span> (<a class="code" href="kb__lrf_8c.html#b96cd18bbb6e3bf6cd880a3dad2f0e12">kb_lrf_DistanceDataSensor</a>[j] &lt; 0xF000)                <span class="comment">/* otherwise error! */</span>
<a name="l00817"></a>00817       {
<a name="l00818"></a>00818         <a class="code" href="kb__lrf_8c.html#7a39d6f9d149563bd6ad02ecafcd4fc5">kb_lrf_DistanceDataSum</a>[j] += <a class="code" href="kb__lrf_8c.html#b96cd18bbb6e3bf6cd880a3dad2f0e12">kb_lrf_DistanceDataSensor</a>[j];      <span class="comment">/* add 'good' values */</span>
<a name="l00819"></a>00819         <a class="code" href="kb__lrf_8c.html#0fd648e59f4d1c01a5659a6384603978">kb_lrf_DistanceGoodCounter</a>[j]++;                                <span class="comment">/* increase counter for good values */</span>
<a name="l00820"></a>00820       }
<a name="l00821"></a>00821     }
<a name="l00822"></a>00822   }
<a name="l00823"></a>00823 
<a name="l00824"></a>00824   <span class="comment">/* averaging */</span>
<a name="l00825"></a>00825   <span class="keywordflow">for</span> (j=0; j&lt;121; j++)
<a name="l00826"></a>00826   {
<a name="l00827"></a>00827     <span class="keywordflow">if</span> (<a class="code" href="kb__lrf_8c.html#0fd648e59f4d1c01a5659a6384603978">kb_lrf_DistanceGoodCounter</a>[j] &gt; 0)
<a name="l00828"></a>00828     {
<a name="l00829"></a>00829       <a class="code" href="kb__lrf_8c.html#781533275742c1891ba6e956323a7834">kb_lrf_DistanceData</a>[j] = <a class="code" href="kb__lrf_8c.html#7a39d6f9d149563bd6ad02ecafcd4fc5">kb_lrf_DistanceDataSum</a>[j]/<a class="code" href="kb__lrf_8c.html#0fd648e59f4d1c01a5659a6384603978">kb_lrf_DistanceGoodCounter</a>[j];
<a name="l00830"></a>00830     } <span class="keywordflow">else</span> {
<a name="l00831"></a>00831       <a class="code" href="kb__lrf_8c.html#781533275742c1891ba6e956323a7834">kb_lrf_DistanceData</a>[j] = 0;
<a name="l00832"></a>00832     }
<a name="l00833"></a>00833   }
<a name="l00834"></a>00834 
<a name="l00835"></a>00835   <span class="keywordflow">return</span>(0);
<a name="l00836"></a>00836 }
<a name="l00837"></a>00837 
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Generated on Wed Dec 15 11:49:26 2010 for KoreBot Library by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.5 </small></address>
</body>
</html>
